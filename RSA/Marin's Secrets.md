# Marin's Secrets
> I've found a super fast way to generate primes from my secret list.

Bài cho ta một file source code như sau: 

```python
#!/usr/bin/env python3

import random
from Crypto.Util.number import bytes_to_long
from secret import secrets, flag


def get_prime(secret):
    prime = 1
    for _ in range(secret):
        prime = prime << 1
    return prime - 1


random.shuffle(secrets)

m = bytes_to_long(flag)
p = get_prime(secrets[0])
q = get_prime(secrets[1])
n = p * q
e = 0x10001
c = pow(m, e, n)

print(f"n = {n}")
print(f"e = {e}")
print(f"c = {c}")
```
Và file output.txt

```
n: 658416274830184544125027519921443515789888264156074733099244040126213682497714032798116399288176502462829255784525977722903018714434309698108208388664768262754316426220651576623731617882923164117579624827261244506084274371250277849351631679441171018418018498039996472549893150577189302871520311715179730714312181456245097848491669795997289830612988058523968384808822828370900198489249243399165125219244753790779764466236965135793576516193213175061401667388622228362042717054014679032953441034021506856017081062617572351195418505899388715709795992029559042119783423597324707100694064675909238717573058764118893225111602703838080618565401139902143069901117174204252871948846864436771808616432457102844534843857198735242005309073939051433790946726672234643259349535186268571629077937597838801337973092285608744209951533199868228040004432132597073390363357892379997655878857696334892216345070227646749851381208554044940444182864026513709449823489593439017366358869648168238735087593808344484365136284219725233811605331815007424582890821887260682886632543613109252862114326372077785369292570900594814481097443781269562647303671428895764224084402259605109600363098950091998891375812839523613295667253813978434879172781217285652895469194181218343078754501694746598738215243769747956572555989594598180639098344891175879455994652382137038240166358066403475457 
e: 65537
c: 400280463088930432319280359115194977582517363610532464295210669530407870753439127455401384569705425621445943992963380983084917385428631223046908837804126399345875252917090184158440305503817193246288672986488987883177380307377025079266030262650932575205141853413302558460364242355531272967481409414783634558791175827816540767545944534238189079030192843288596934979693517964655661507346729751987928147021620165009965051933278913952899114253301044747587310830419190623282578931589587504555005361571572561916866063458812965314474160499067525067495140150092119620928363007467390920130717521169105167963364154636472055084012592138570354390246779276003156184676298710746583104700516466091034510765027167956117869051938116457370384737440965109619578227422049806566060571831017610877072484262724789571076529586427405780121096546942812322324807145137017942266863534989082115189065560011841150908380937354301243153206428896320576609904361937035263985348984794208198892615898907005955403529470847124269512316191753950203794578656029324506688293446571598506042198219080325747328636232040936761788558421528960279832802127562115852304946867628316502959562274485483867481731149338209009753229463924855930103271197831370982488703456463385914801246828662212622006947380115549529820197355738525329885232170215757585685484402344437894981555179129287164971002033759724456
```


Phân tích đoạn code trên: Hàm `get\_prime` sinh ra các số nguyên có dạng $\displaystyle 2^{secret} -1$ và số $\displaystyle n$ của ta cũng có dạng $\displaystyle \left( 2^{a} -1\right)\left( 2^{b} -1\right)$ với $\displaystyle a,b$ được lấy ngẫu nhiên từ secrets. Vấn đề ở đây ta không biết $\displaystyle 2^{a} -1$ và $\displaystyle 2^{b} -1$ có phải là số nguyên tố hay không. Điều kiện cần để $\displaystyle 2^{a} -1$ là một số nguyên tố đó chính là $\displaystyle a$ cũng phải là số nguyên tố. Vậy ta cần phải xác định cách để phân tích $\displaystyle n$ nếu ta biết $\displaystyle n$ có dạng $\displaystyle n=\left( 2^{a} -1\right)\left( 2^{b} -1\right)$.

Trước tiên ta đi giải quyết bài toán dễ trước đó chính là giả sử $\displaystyle 2^{a} -1,2^{b} -1$ đều là các số nguyên tố thì ta sẽ phân tích như thế nào. 

Nhưng có một điều khá đáng buồn ở bài này đó là khi mình xài tool phân tích [FactorDb](https://factordb.com/index.php?query=658416274830184544125027519921443515789888264156074733099244040126213682497714032798116399288176502462829255784525977722903018714434309698108208388664768262754316426220651576623731617882923164117579624827261244506084274371250277849351631679441171018418018498039996472549893150577189302871520311715179730714312181456245097848491669795997289830612988058523968384808822828370900198489249243399165125219244753790779764466236965135793576516193213175061401667388622228362042717054014679032953441034021506856017081062617572351195418505899388715709795992029559042119783423597324707100694064675909238717573058764118893225111602703838080618565401139902143069901117174204252871948846864436771808616432457102844534843857198735242005309073939051433790946726672234643259349535186268571629077937597838801337973092285608744209951533199868228040004432132597073390363357892379997655878857696334892216345070227646749851381208554044940444182864026513709449823489593439017366358869648168238735087593808344484365136284219725233811605331815007424582890821887260682886632543613109252862114326372077785369292570900594814481097443781269562647303671428895764224084402259605109600363098950091998891375812839523613295667253813978434879172781217285652895469194181218343078754501694746598738215243769747956572555989594598180639098344891175879455994652382137038240166358066403475457)
thì ra luôn 2 thừa số nguyên tố =))

Cụ thể như này: 
```python
from Crypto.Util.number import *
from sage.all import *
n=658416274830184544125027519921443515789888264156074733099244040126213682497714032798116399288176502462829255784525977722903018714434309698108208388664768262754316426220651576623731617882923164117579624827261244506084274371250277849351631679441171018418018498039996472549893150577189302871520311715179730714312181456245097848491669795997289830612988058523968384808822828370900198489249243399165125219244753790779764466236965135793576516193213175061401667388622228362042717054014679032953441034021506856017081062617572351195418505899388715709795992029559042119783423597324707100694064675909238717573058764118893225111602703838080618565401139902143069901117174204252871948846864436771808616432457102844534843857198735242005309073939051433790946726672234643259349535186268571629077937597838801337973092285608744209951533199868228040004432132597073390363357892379997655878857696334892216345070227646749851381208554044940444182864026513709449823489593439017366358869648168238735087593808344484365136284219725233811605331815007424582890821887260682886632543613109252862114326372077785369292570900594814481097443781269562647303671428895764224084402259605109600363098950091998891375812839523613295667253813978434879172781217285652895469194181218343078754501694746598738215243769747956572555989594598180639098344891175879455994652382137038240166358066403475457 
e=65537
c=400280463088930432319280359115194977582517363610532464295210669530407870753439127455401384569705425621445943992963380983084917385428631223046908837804126399345875252917090184158440305503817193246288672986488987883177380307377025079266030262650932575205141853413302558460364242355531272967481409414783634558791175827816540767545944534238189079030192843288596934979693517964655661507346729751987928147021620165009965051933278913952899114253301044747587310830419190623282578931589587504555005361571572561916866063458812965314474160499067525067495140150092119620928363007467390920130717521169105167963364154636472055084012592138570354390246779276003156184676298710746583104700516466091034510765027167956117869051938116457370384737440965109619578227422049806566060571831017610877072484262724789571076529586427405780121096546942812322324807145137017942266863534989082115189065560011841150908380937354301243153206428896320576609904361937035263985348984794208198892615898907005955403529470847124269512316191753950203794578656029324506688293446571598506042198219080325747328636232040936761788558421528960279832802127562115852304946867628316502959562274485483867481731149338209009753229463924855930103271197831370982488703456463385914801246828662212622006947380115549529820197355738525329885232170215757585685484402344437894981555179129287164971002033759724456
p=2**2203-1
q=2**2281-1
phi=(p-1)*(q-1)
d=inverse(e,phi)
m=pow(c,d,n)
print(long_to_bytes(m))
```
Bây giờ giả sử như tool của ta không hoạt động thì ta phải làm sao? Các số nguyên tố có dạng $\displaystyle 2^{a} -1$ được gọi là các số nguyên tố Mersenne. Ngoài ra với $\displaystyle n=\left( 2^{a} -1\right)\left( 2^{b} -1\right)$ thì $\displaystyle n\sim 2^{a+b}$ cho nên nếu ta lấy phần nguyên của logarit cơ số 2 của $\displaystyle n$ sẽ ra được tổng của hai số nguyên tố. 

```python
from math import *
n=658416274830184544125027519921443515789888264156074733099244040126213682497714032798116399288176502462829255784525977722903018714434309698108208388664768262754316426220651576623731617882923164117579624827261244506084274371250277849351631679441171018418018498039996472549893150577189302871520311715179730714312181456245097848491669795997289830612988058523968384808822828370900198489249243399165125219244753790779764466236965135793576516193213175061401667388622228362042717054014679032953441034021506856017081062617572351195418505899388715709795992029559042119783423597324707100694064675909238717573058764118893225111602703838080618565401139902143069901117174204252871948846864436771808616432457102844534843857198735242005309073939051433790946726672234643259349535186268571629077937597838801337973092285608744209951533199868228040004432132597073390363357892379997655878857696334892216345070227646749851381208554044940444182864026513709449823489593439017366358869648168238735087593808344484365136284219725233811605331815007424582890821887260682886632543613109252862114326372077785369292570900594814481097443781269562647303671428895764224084402259605109600363098950091998891375812839523613295667253813978434879172781217285652895469194181218343078754501694746598738215243769747956572555989594598180639098344891175879455994652382137038240166358066403475457
print(floor(log2(n)))

print(bin(n)[2:])

```
Tiếp theo ta viết lại $\displaystyle n=\left( 2^{a} -1\right)\left( 2^{b} -1\right) =2^{a+b} -2^{a} -2^{b} +1=\left( 2^{a+b} -1\right) -\left( 2^{a} -1\right) -\left( 2^{b} -1\right)$. Bây giờ các số $\displaystyle 2^{t} -1$ khi biểu diễn nhị phân chỉ toàn gồm các số 1. Ta giả sử $\displaystyle a >b$ thì khi đó ta xét $\displaystyle 2^{a+b} -1$ gồm toàn các chữ số 1. Khi ta lấy số trên trừ cho $\displaystyle 2^{a} -1$ thì $\displaystyle a$ bit đầu tiên trong số $\displaystyle a+b$ bit của số $\displaystyle 2^{a+b} -1$ sẽ trở về 0. Sau đó nếu ta lấy số trên từ tiếp cho $\displaystyle 2^{b} -1$ thì ta sẽ được một số có bit đầu tiên là 1, sau đó tiếp tục đi từ phải sang trái thực hiện phép trừ, nếu như bit bị trừ là 0 thì khi trừ kết quả sẽ ra 0 và nếu bit bị trừ là 1 thì kết quả sẽ trả về 1, phép toán sẽ dừng tại một bit mà kể từ bit đó về sau không còn số 0 nào nữa. Khi viết $\displaystyle n$ về dưới dạng nhị phân ta để ý thấy có một vị trí mà tại đó các bit còn lại không có bit nào bằng 0 nữa 

![image](https://github.com/user-attachments/assets/f4522332-cb52-49a8-9821-316a712c2f4b)

Như vậy ta sẽ lấy các bit ở phía sau số 0 này và chuyển thành số thập phân, tiếp theo lấy phần nguyên của log2 thì sẽ ra được 1 trong 2 số nguyên tố. Tới đây thì ta coi như giải quyết được bài tập. 
```python
from math import *
n=658416274830184544125027519921443515789888264156074733099244040126213682497714032798116399288176502462829255784525977722903018714434309698108208388664768262754316426220651576623731617882923164117579624827261244506084274371250277849351631679441171018418018498039996472549893150577189302871520311715179730714312181456245097848491669795997289830612988058523968384808822828370900198489249243399165125219244753790779764466236965135793576516193213175061401667388622228362042717054014679032953441034021506856017081062617572351195418505899388715709795992029559042119783423597324707100694064675909238717573058764118893225111602703838080618565401139902143069901117174204252871948846864436771808616432457102844534843857198735242005309073939051433790946726672234643259349535186268571629077937597838801337973092285608744209951533199868228040004432132597073390363357892379997655878857696334892216345070227646749851381208554044940444182864026513709449823489593439017366358869648168238735087593808344484365136284219725233811605331815007424582890821887260682886632543613109252862114326372077785369292570900594814481097443781269562647303671428895764224084402259605109600363098950091998891375812839523613295667253813978434879172781217285652895469194181218343078754501694746598738215243769747956572555989594598180639098344891175879455994652382137038240166358066403475457
print(floor(log2(n)))
print(bin(n)[2:])
def binary_to_decimal(binary_str):
    return int(binary_str, 2)
binary = "01111111111111111111111111111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001"
print(binary_to_decimal(binary)) 
p=floor(log2(binary_to_decimal(binary)))
print(floor(log2(binary_to_decimal(binary))))
q=floor(log2(n))-p
print(f"2 số nguyên tố cần tìm là {p},{q}")
```

Một tài liệu khác thú vị [A New Public-Key Cryptosystem via Mersenne Numbers](https://eprint.iacr.org/2017/481.pdf)
